<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACS AI Voice Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root {
            --primary-color: #161616;
            --secondary-color: #3fcbb2;
            --accent-color: #564ebb;
            --dark-color: #161616;
            --light-color: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: var(--primary-color);
        }

        .logo {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 150px;
            z-index: 10;
            filter: brightness(0) invert(1);
        }

        .control-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .toggle-button {
            background-color: var(--secondary-color);
            border: none;
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            min-width: 120px;
        }

        .toggle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }

        .toggle-button:active {
            transform: translateY(0);
        }

        .toggle-button.active {
            background-color: var(--accent-color);
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .animation-container {
            width: 500px;
            height: 500px;
            margin: 0 auto;
            position: relative;
        }

        .animation-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            opacity: 0;
            background: radial-gradient(circle, rgba(63, 203, 178, 0.3) 0%, rgba(0, 0, 0, 0) 70%);
            z-index: -1;
            transition: opacity 0.5s;
        }

        .ai-speaking .animation-glow {
            opacity: 1;
            animation: pulse-glow 2s infinite alternate;
        }

        @keyframes pulse-glow {
            0% { transform: scale(0.95); opacity: 0.7; }
            100% { transform: scale(1.05); opacity: 0.3; }
        }

        .user-speaking-indicator {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(204, 204, 204, 0.5);
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .user-speaking {
            animation: pulse 1.2s infinite alternate;
            box-shadow: 0 0 20px rgba(86, 78, 187, 0.5);
        }

        @keyframes pulse {
            0% { background-color: var(--accent-color); transform: translateX(-50%) scale(1); }
            100% { background-color: var(--secondary-color); transform: translateX(-50%) scale(1.3); }
        }

        .status-text {
            position: fixed;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 16px;
            color: var(--light-color);
            opacity: 0.9;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <img src="logo.svg" alt="Company Logo" class="logo">

    <div class="control-buttons">
        <button id="toggleButton" class="toggle-button">ON</button>
    </div>

    <div class="main-container">
        <div class="animation-container" id="animationWrapper">
            <div class="animation-glow"></div>
            <div id="animationContainer"></div>
        </div>

        <div class="user-speaking-indicator" id="userSpeakingIndicator"></div>
        <div class="status-text" id="statusText">Welcome to our AI Voice Assistant</div>
    </div>

    <script>
        // UI elements
        const toggleButton = document.getElementById('toggleButton');
        const animationContainer = document.getElementById('animationContainer');
        const animationWrapper = document.getElementById('animationWrapper');
        const userSpeakingIndicator = document.getElementById('userSpeakingIndicator');
        const statusText = document.getElementById('statusText');

        // Animation URLs
        const idleAnimation = 'https://lottie.host/aec2610e-f5fb-4861-8c9b-bf26695a655b/epnReZjYSz.json';
        const talkingAnimation = 'https://lottie.host/14f75e6d-e9ac-4f25-b48a-197002332f02/lisRG3x07s.json';

        // Global variables
        let pc = null;
        let dc = null;
        let micStream = null;
        let audioEl = null;
        let animation = null;
        let isActive = false;

        // Event listeners
        toggleButton.addEventListener('click', toggleConversation);

        // Initialize idle animation
        document.addEventListener('DOMContentLoaded', () => {
            animation = lottie.loadAnimation({
                container: animationContainer,
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: idleAnimation
            });
        });

        // Toggle conversation on/off
        function toggleConversation() {
            if (!isActive) {
                startConversation();
            } else {
                stopConversation();
            }
        }

        // Start conversation
        async function startConversation() {
            try {
                // Update UI
                toggleButton.textContent = "OFF";
                toggleButton.classList.add('active');
                isActive = true;
                statusText.textContent = "Connecting to AI...";

                // Clean up any previous session
                if (pc) {
                    stopConversation();
                }

                // Get session token from our server
                const tokenResponse = await fetch("/session");
                const data = await tokenResponse.json();
                console.log("Session data:", data);

                if (!tokenResponse.ok) {
                    throw new Error(`Server error: ${data.error || tokenResponse.statusText}`);
                }

                const EPHEMERAL_KEY = data.client_secret.value;

                // Create a peer connection
                pc = new RTCPeerConnection();

                // Set up audio element for AI's voice
                audioEl = document.createElement("audio");
                audioEl.autoplay = true;
                document.body.appendChild(audioEl);

                pc.ontrack = e => {
                    audioEl.srcObject = e.streams[0];
                    statusText.textContent = "AI is ready to talk";

                    // Create audio context to detect when AI is speaking
                    const audioContext = new AudioContext();
                    const source = audioContext.createMediaStreamSource(e.streams[0]);
                    const analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    source.connect(analyser);

                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    // Switch to talking animation when AI speaks
                    if (animation) {
                        animation.destroy();
                    }

                    animation = lottie.loadAnimation({
                        container: animationContainer,
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: idleAnimation
                    });

                    // Regularly check if AI is speaking
                    function checkAudioLevel() {
                        if (!audioEl || !audioEl.srcObject) return;

                        analyser.getByteFrequencyData(dataArray);
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            sum += dataArray[i];
                        }

                        const average = sum / bufferLength;

                        if (average > 10) { // AI is speaking
                            if (!animationWrapper.classList.contains('ai-speaking')) {
                                animationWrapper.classList.add('ai-speaking');
                                if (animation) {
                                    animation.destroy();
                                    animation = lottie.loadAnimation({
                                        container: animationContainer,
                                        renderer: 'svg',
                                        loop: true,
                                        autoplay: true,
                                        path: talkingAnimation
                                    });
                                }
                            }
                        } else { // AI is not speaking
                            if (animationWrapper.classList.contains('ai-speaking')) {
                                animationWrapper.classList.remove('ai-speaking');
                                if (animation) {
                                    animation.destroy();
                                    animation = lottie.loadAnimation({
                                        container: animationContainer,
                                        renderer: 'svg',
                                        loop: true,
                                        autoplay: true,
                                        path: idleAnimation
                                    });
                                }
                            }
                        }

                        if (pc && isActive) {
                            requestAnimationFrame(checkAudioLevel);
                        }
                    }

                    requestAnimationFrame(checkAudioLevel);
                };

                // Add local audio track (microphone)
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                micStream.getTracks().forEach(track => pc.addTrack(track, micStream));

                // Set up data channel
                dc = pc.createDataChannel("oai-events");
                dc.addEventListener("message", handleMessage);

                // Create and send offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const baseUrl = "https://api.openai.com/v1/realtime";
                const model = "gpt-4o-realtime-preview-2024-12-17";

                const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
                    method: "POST",
                    body: offer.sdp,
                    headers: {
                        Authorization: `Bearer ${EPHEMERAL_KEY}`,
                        "Content-Type": "application/sdp"
                    },
                });

                if (!sdpResponse.ok) {
                    throw new Error(`Failed to connect: ${sdpResponse.status} ${sdpResponse.statusText}`);
                }

                const answer = {
                    type: "answer",
                    sdp: await sdpResponse.text(),
                };

                await pc.setRemoteDescription(answer);
                statusText.textContent = "Connected - I'm listening...";

            } catch (error) {
                console.error('Error starting conversation:', error);
                statusText.textContent = `Error: ${error.message}`;
                toggleButton.textContent = "ON";
                toggleButton.classList.remove('active');
                isActive = false;
            }
        }

        // Handle messages from the data channel
        function handleMessage(event) {
            const data = JSON.parse(event.data);
            console.log("Received event:", data);

            if (data.type === "input_audio_buffer.speech_started") {
                console.log("User started speaking");
                userSpeakingIndicator.classList.add('user-speaking');
                statusText.textContent = "Listening to you...";
            } else if (data.type === "input_audio_buffer.speech_stopped") {
                console.log("User stopped speaking");
                userSpeakingIndicator.classList.remove('user-speaking');
                statusText.textContent = "Processing your request...";
            }
        }

        // Stop conversation
        function stopConversation() {
            // Update UI state
            toggleButton.textContent = "ON";
            toggleButton.classList.remove('active');
            isActive = false;

            // Close data channel
            if (dc) {
                dc.close();
                dc = null;
            }

            // Close peer connection
            if (pc) {
                pc.close();
                pc = null;
            }

            // Stop microphone
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }

            // Stop audio
            if (audioEl) {
                audioEl.pause();
                audioEl.srcObject = null;
            }

            // Reset animation to idle
            animationWrapper.classList.remove('ai-speaking');
            if (animation) {
                animation.destroy();
            }

            animation = lottie.loadAnimation({
                container: animationContainer,
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: idleAnimation
            });

            // Update UI
            userSpeakingIndicator.classList.remove('user-speaking');
            statusText.textContent = "Welcome to our AI Voice Assistant";
        }
    </script>
</body>
</html>